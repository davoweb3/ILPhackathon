{"ast":null,"code":"\"use strict\";\n\n/*\n* Copyright 2013 ZXing authors\n*\n* Licensed under the Apache License, Version 2.0 (the \"License\");\n* you may not use this file except in compliance with the License.\n* You may obtain a copy of the License at\n*\n*      http://www.apache.org/licenses/LICENSE-2.0\n*\n* Unless required by applicable law or agreed to in writing, software\n* distributed under the License is distributed on an \"AS IS\" BASIS,\n* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n* See the License for the specific language governing permissions and\n* limitations under the License.\n*/\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n// package com.google.zxing.pdf417.decoder;\n// import com.google.zxing.common.detector.MathUtils;\nvar MathUtils_1 = require(\"../../common/detector/MathUtils\");\n// import com.google.zxing.pdf417.PDF417Common;\nvar PDF417Common_1 = require(\"../PDF417Common\");\nvar Float_1 = require(\"../../util/Float\");\n/**\n * @author Guenther Grau\n * @author creatale GmbH (christoph.schulz@creatale.de)\n */\nvar PDF417CodewordDecoder = /** @class */function () {\n  function PDF417CodewordDecoder() {}\n  /* @note\n   * this action have to be performed before first use of class\n   * - static constructor\n   * working with 32bit float (based from Java logic)\n  */\n  PDF417CodewordDecoder.initialize = function () {\n    // Pre-computes the symbol ratio table.\n    for ( /*int*/var i = 0; i < PDF417Common_1.default.SYMBOL_TABLE.length; i++) {\n      var currentSymbol = PDF417Common_1.default.SYMBOL_TABLE[i];\n      var currentBit = currentSymbol & 0x1;\n      for ( /*int*/var j = 0; j < PDF417Common_1.default.BARS_IN_MODULE; j++) {\n        var size = 0.0;\n        while ((currentSymbol & 0x1) === currentBit) {\n          size += 1.0;\n          currentSymbol >>= 1;\n        }\n        currentBit = currentSymbol & 0x1;\n        if (!PDF417CodewordDecoder.RATIOS_TABLE[i]) {\n          PDF417CodewordDecoder.RATIOS_TABLE[i] = new Array(PDF417Common_1.default.BARS_IN_MODULE);\n        }\n        PDF417CodewordDecoder.RATIOS_TABLE[i][PDF417Common_1.default.BARS_IN_MODULE - j - 1] = Math.fround(size / PDF417Common_1.default.MODULES_IN_CODEWORD);\n      }\n    }\n    this.bSymbolTableReady = true;\n  };\n  PDF417CodewordDecoder.getDecodedValue = function (moduleBitCount) {\n    var decodedValue = PDF417CodewordDecoder.getDecodedCodewordValue(PDF417CodewordDecoder.sampleBitCounts(moduleBitCount));\n    if (decodedValue !== -1) {\n      return decodedValue;\n    }\n    return PDF417CodewordDecoder.getClosestDecodedValue(moduleBitCount);\n  };\n  PDF417CodewordDecoder.sampleBitCounts = function (moduleBitCount) {\n    var bitCountSum = MathUtils_1.default.sum(moduleBitCount);\n    var result = new Int32Array(PDF417Common_1.default.BARS_IN_MODULE);\n    var bitCountIndex = 0;\n    var sumPreviousBits = 0;\n    for ( /*int*/var i = 0; i < PDF417Common_1.default.MODULES_IN_CODEWORD; i++) {\n      var sampleIndex = bitCountSum / (2 * PDF417Common_1.default.MODULES_IN_CODEWORD) + i * bitCountSum / PDF417Common_1.default.MODULES_IN_CODEWORD;\n      if (sumPreviousBits + moduleBitCount[bitCountIndex] <= sampleIndex) {\n        sumPreviousBits += moduleBitCount[bitCountIndex];\n        bitCountIndex++;\n      }\n      result[bitCountIndex]++;\n    }\n    return result;\n  };\n  PDF417CodewordDecoder.getDecodedCodewordValue = function (moduleBitCount) {\n    var decodedValue = PDF417CodewordDecoder.getBitValue(moduleBitCount);\n    return PDF417Common_1.default.getCodeword(decodedValue) === -1 ? -1 : decodedValue;\n  };\n  PDF417CodewordDecoder.getBitValue = function (moduleBitCount) {\n    var result = /*long*/0;\n    for (var /*int*/i = 0; i < moduleBitCount.length; i++) {\n      for ( /*int*/var bit = 0; bit < moduleBitCount[i]; bit++) {\n        result = result << 1 | (i % 2 === 0 ? 1 : 0);\n      }\n    }\n    return Math.trunc(result);\n  };\n  // working with 32bit float (as in Java)\n  PDF417CodewordDecoder.getClosestDecodedValue = function (moduleBitCount) {\n    var bitCountSum = MathUtils_1.default.sum(moduleBitCount);\n    var bitCountRatios = new Array(PDF417Common_1.default.BARS_IN_MODULE);\n    if (bitCountSum > 1) {\n      for (var /*int*/i = 0; i < bitCountRatios.length; i++) {\n        bitCountRatios[i] = Math.fround(moduleBitCount[i] / bitCountSum);\n      }\n    }\n    var bestMatchError = Float_1.default.MAX_VALUE;\n    var bestMatch = -1;\n    if (!this.bSymbolTableReady) {\n      PDF417CodewordDecoder.initialize();\n    }\n    for ( /*int*/var j = 0; j < PDF417CodewordDecoder.RATIOS_TABLE.length; j++) {\n      var error = 0.0;\n      var ratioTableRow = PDF417CodewordDecoder.RATIOS_TABLE[j];\n      for ( /*int*/var k = 0; k < PDF417Common_1.default.BARS_IN_MODULE; k++) {\n        var diff = Math.fround(ratioTableRow[k] - bitCountRatios[k]);\n        error += Math.fround(diff * diff);\n        if (error >= bestMatchError) {\n          break;\n        }\n      }\n      if (error < bestMatchError) {\n        bestMatchError = error;\n        bestMatch = PDF417Common_1.default.SYMBOL_TABLE[j];\n      }\n    }\n    return bestMatch;\n  };\n  // flag that the table is ready for use\n  PDF417CodewordDecoder.bSymbolTableReady = false;\n  PDF417CodewordDecoder.RATIOS_TABLE = new Array(PDF417Common_1.default.SYMBOL_TABLE.length).map(function (x) {\n    return x = new Array(PDF417Common_1.default.BARS_IN_MODULE);\n  });\n  return PDF417CodewordDecoder;\n}();\nexports.default = PDF417CodewordDecoder;","map":{"version":3,"names":["MathUtils_1","require","PDF417Common_1","Float_1","PDF417CodewordDecoder","initialize","i","default","SYMBOL_TABLE","length","currentSymbol","currentBit","j","BARS_IN_MODULE","size","RATIOS_TABLE","Array","Math","fround","MODULES_IN_CODEWORD","bSymbolTableReady","getDecodedValue","moduleBitCount","decodedValue","getDecodedCodewordValue","sampleBitCounts","getClosestDecodedValue","bitCountSum","sum","result","Int32Array","bitCountIndex","sumPreviousBits","sampleIndex","getBitValue","getCodeword","bit","trunc","bitCountRatios","bestMatchError","MAX_VALUE","bestMatch","error","ratioTableRow","k","diff","map","x"],"sources":["../../../../src/core/pdf417/decoder/PDF417CodewordDecoder.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script"}